/*	DES ENCRYPTION AND DECRYPTION
 *	copyright (c) 1980 by Whitesmiths, Ltd.
 */
#include <std.h>

/*	the tables S8 - S1, index flipped end for end
 */
LOCAL TINY mtab[8][64] {
	{13,  7, 10,  0,  6,  9,  5, 15,  8,  4,  3, 10, 11, 14, 12,  5,
	  2, 11,  9,  6, 15, 12,  0,  3,  4,  1, 14, 13,  1,  2,  7,  8,
	  1,  2, 12, 15, 10,  4,  0,  3, 13, 14,  6,  9,  7,  8,  9,  6,
	 15,  1,  5, 12,  3, 10, 14,  5,  8,  7, 11,  0,  4, 13,  2, 11},
	{ 4,  1,  3, 10, 15, 12,  5,  0,  2, 11,  9,  6,  8,  7,  6,  9,
	 11, 14, 12, 15,  0,  3, 10,  5, 14, 13,  7,  8, 13, 14,  1,  2,
	 13,  6, 14,  9,  4,  1,  2, 14, 11, 13,  5,  0,  1, 10,  8,  3,
	  0, 11,  3,  5,  9,  4, 15,  2,  7,  8, 12, 15, 10,  7,  6, 12},
	{12,  9,  0,  7,  9,  2, 14,  1, 10, 15,  3,  4,  6, 12,  5, 11,
	  1, 14, 13,  0,  2,  8,  7, 13, 15,  5,  4, 10,  8,  3, 11,  6,
	  0,  4,  6, 11,  7,  9,  0,  6,  4,  2, 13,  1,  9, 15,  3,  8,
	 15,  3,  1, 14, 12,  5, 11,  0,  2, 12, 14,  7,  5, 10,  8, 13},
	{ 2,  4,  8, 15,  7, 10, 13,  6,  4,  1,  3, 12, 11,  7, 14,  0,
	 12,  2,  5,  9, 10, 13,  0,  3,  1, 11, 15,  5,  6,  8,  9, 14,
	 14, 11,  5,  6,  4,  1,  3, 10,  2, 12, 15,  0, 13,  2,  8,  5,
	 11,  8,  0, 15,  7, 14,  9,  4, 12,  7, 10,  9,  1, 13,  6, 3},
	{ 7, 10,  1, 15,  0, 12, 11,  5, 14,  9,  8,  3,  9,  7,  4,  8,
	 13,  6,  2,  1,  6, 11, 12,  2,  3,  0,  4, 14, 10, 13, 15,  4,
	 13,  3,  4,  9,  6, 10,  1, 12, 11,  0,  2,  5,  0, 13, 14,  2,
	  8, 15,  7,  4, 15,  1, 10,  7,  5,  6, 12, 11,  3,  8,  9, 14},
	{10, 13,  1, 11,  6,  8, 11,  5,  9,  4, 12,  2, 15,  3,  2, 14,
	  0,  6, 13,  1,  3, 15,  4, 10, 14,  9,  7, 12,  5,  0,  8,  7,
	 13,  1,  2,  4,  3,  6, 12, 11,  0, 13,  5, 14,  6,  8, 15,  2,
	  7, 10,  8,  5,  4,  9, 11,  5,  9,  0, 14,  3, 10,  7,  1, 12},
	{15,  0,  9,  5,  6, 10, 12,  7,  8,  7,  2, 12,  3, 13,  5,  2,
	  1, 14,  7,  8, 11,  4,  0,  3, 14, 11, 13,  6,  4,  1, 10, 15,
	  3, 13, 12, 11, 15,  3,  6,  0,  4, 10,  1,  7,  8,  4, 11, 14,
	 13,  8,  0,  6,  2, 15,  9,  5,  7,  1, 10, 12, 14,  2,  5, 9},
	{14,  4,  3, 15,  2, 13,  5,  3, 13, 14,  6,  9, 11,  2,  0,  5,
	  4,  1, 10, 12, 15,  6,  9, 10,  1,  8, 12,  7,  8, 11,  7,  0,
	  0, 15, 10,  5, 14,  4, 12,  3,  7,  8, 12,  3, 13,  1,  3,  6,
	 15, 12,  6, 11,  2,  9,  5,  0,  4,  2, 11, 14,  1,  7,  8, 13}};

/*	the initial permutation IP, counting from zero
 *	N.B. pt0[32] is inverse of IP-1, with halves flipped
 */
LOCAL TINY pt0[] {
	57, 49, 41, 33, 25, 17,  9,  1, 59, 51, 43, 35, 27, 19, 11,  3,
	61, 53, 45, 37, 29, 21, 13,  5, 63, 55, 47, 39, 31, 23, 15,  7,
	56, 48, 40, 32, 24, 16,  8,  0, 58, 50, 42, 34, 26, 18, 10,  2,
	60, 52, 44, 36, 28, 20, 12,  4, 62, 54, 46, 38, 30, 22, 14,  6,
	57, 49, 41, 33, 25, 17,  9,  1, 59, 51, 43, 35, 27, 19, 11,  3,
	61, 53, 45, 37, 29, 21, 13,  5, 63, 55, 47, 39, 31, 23, 15,  7};

/*	the E selection, packing six bits per byte
 */
LOCAL TINY pt1[] {
	31,  0,  1,  2,  3,  4, 64, 64,  3,  4,  5,  6,  7,  8, 64, 64,
	 7,  8,  9, 10, 11, 12, 64, 64, 11, 12, 13, 14, 15, 16, 64, 64,
	15, 16, 17, 18, 19, 20, 64, 64, 19, 20, 21, 22, 23, 24, 64, 64,
	23, 24, 25, 26, 27, 28, 64, 64, 27, 28, 29, 30, 31,  0, 64, 64};

/*	the P permutation, four bits per byte down to 32 bits
 */
LOCAL TINY pt2[] {
	27, 10, 35, 40, 56, 19, 51, 32,  0, 26, 42, 49,  8, 33, 58, 17,
	 1, 11, 43, 25, 59, 50,  2, 16, 34, 24, 57,  9, 41, 18,  3, 48};

/*	the inverse of IP
 */
LOCAL TINY pt3[] {
	39,  7, 47, 15, 55, 23, 63, 31, 38,  6, 46, 14, 54, 22, 62, 30,
	37,  5, 45, 13, 53, 21, 61, 29, 36,  4, 44, 12, 52, 20, 60, 28,
	35,  3, 43, 11, 51, 19, 59, 27, 34,  2, 42, 10, 50, 18, 58, 26,
	33,  1, 41,  9, 49, 17, 57, 25, 32,  0, 40,  8, 48, 16, 56, 24};

/*	IP-1-1, preceded by flip
 */
LOCAL TINY pt4[] {
	 7, 39, 15, 47, 23, 55, 31, 63,  6, 38, 14, 46, 22, 54, 30, 62,
	 5, 37, 13, 45, 21, 53, 29, 61,  4, 36, 12, 44, 20, 52, 28, 60,
	 3, 35, 11, 43, 19, 51, 27, 59,  2, 34, 10, 42, 18, 50, 26, 58,
	 1, 33,  9, 41, 17, 49, 25, 57,  0, 32,  8, 40, 16, 48, 24, 56};

/*	permute from into to by table
 */
LOCAL VOID _px(to, from, tab, n)
	TEXT *to, *from;
	FAST TINY *tab;
	COUNT n;
	{
	FAST COUNT j, val;
	INTERN TINY bit[] {0001, 0002, 0004, 0010, 0020, 0040, 0100, 0200};

	for (val = 0; 0 <= --n; *to++ = val)
		for (j = 8; 0 <= --j; ++tab)
			{
			val =>> 1;
			if (from[*tab >> 3] & bit[*tab & 07])
				val =| 0200;
			}
	}

/*	build key schedule from key
 */
TEXT *bldks(ks, key)
	TEXT ks[16][8], key[8];
	{
	FAST COUNT i;
	FAST TEXT *os, *s;
	INTERN TINY p0[] {	/* PC1 * LS1 * PC2 */
		 9, 50, 33, 18, 48, 16, 49, -0, 32, 56,  1,  8, 18, 41, 42, -0, 
		 2, 34, 25, 24, 43, 57, 10, -0, 58,  0, 35, 26, 17, 40, 51, -0, 
		21, 27, 38, 53, 36,  3,  6, -0, 46, 29,  4, 52, 22, 28, 45, -0,
		60, 20, 37, 62, 14, 19,  5, -0, 44, 13, 12, 61, 54, 30, 11, -0};
	INTERN TINY p1[] {	/* PC2-1 * LS1 * PC2 */
		10, 14, 18, 30, 29, 11, 13, -0, 19,  4, 24, 25, 22,  2, 17, -0,
		 3, 27, 28,  5, 26,  6, 16, -0,  1, 21,  9, 12,  0,  8, 20, -0, 
		57, 53, 61, 46, 45, 51, 59, -0, 34, 32, 33, 56, 52, 49, 50, -0,
		43, 58, 41, 60, 38, 62, 48, -0, 36, 54, 42, 35, 40, 44, 37, -0};
	INTERN TINY p2[] {	/* PC2-1 * LS1 * LS1 * PC2 */
		24, 17, 28, 20,  8, 25,  2, -0,  5, 29,  1, 21, 16, 18, 27, -0,
		30, 12,  0, 11,  9, 13,  3, -0, 14,  6,  4, 22, 10, 19, 26, -0,
		54, 62, 44, 50, 49, 60, 35, -0, 61, 57, 53, 36, 38, 58, 41, -0,
		56, 42, 32, 40, 59, 37, 43, -0, 45, 48, 33, 46, 34, 52, 51, -0};
	INTERN TINY *pt[] {	/* reverse order */
		p1, p2, p2, p2, p2, p2, p2, p1, p2, p2, p2, p2, p2, p2, p1, p0};

	for (i = 16, os = key, s = ks; 0 <= --i; os = s, s =+ 8)
		_px(s, os, pt[i], 8);
	for (i = 16*8, s = ks; 0 <= --i; )
		*s++ =& 077;
	return (ks);
	}

/*	decrypt a block of text
 */
TEXT *decrypt(data, ks)
	TEXT data[8], ks[16][8];
	{
	IMPORT TINY mtab[8][64], pt0[], pt1[], pt2[], pt3[];
	FAST COUNT j;
	FAST TINY *pk, *pv;
	COUNT i;
	TINY dbuf[9], sbuf[8], ubuf[4], v;

	dbuf[8] = 0;
	_px(dbuf, data, &pt0[32], 8);
	for (pk = ks[16-1], i = 16; 0 <= --i; pk =- 2*8)
		{
		_px(sbuf, &dbuf[0], pt1, 8);
		for (pv = sbuf, j = 8; 0 <= --j; )
			*pv = mtab[j][*pv ^ *pk++];
		_px(ubuf, sbuf, pt2, 4);
		for (pv = dbuf, j = 4; 0 <= --j; ++pv)
			{
			v = pv[0];
			pv[0] = pv[4] ^ ubuf[j];
			pv[4] = v;
			}
		}
	_px(data, dbuf, pt3, 8);
	return (data);
	}

/*	encrypt a block of text
 */
TEXT *encrypt(data, ks)
	TEXT data[8], ks[16][8];
	{
	IMPORT TINY mtab[8][64], pt0[], pt1[], pt2[], pt4[];
	FAST COUNT j;
	FAST TINY *pk, *pv;
	COUNT i;
	TINY dbuf[13], sbuf[8], ubuf[4], v;

	dbuf[8] = 0;
	dbuf[12] = 0;
	_px(dbuf, data, &pt0[0], 8);
	for (pk = ks[0], i = 16; 0 <= --i; )
		{
		_px(sbuf, &dbuf[4], pt1, 8);
		for (pv = sbuf, j = 8; 0 <= --j; )
			*pv = mtab[j][*pv ^ *pk++];
		_px(ubuf, sbuf, pt2, 4);
		for (pv = dbuf, j = 4; 0 <= --j; ++pv)
			{
			v = pv[4];
			pv[4] = pv[0] ^ ubuf[j];
			pv[0] = v;
			}
		}
	_px(data, dbuf, pt4, 8);
	return (data);
	}
